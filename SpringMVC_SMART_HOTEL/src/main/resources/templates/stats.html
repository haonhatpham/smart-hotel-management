<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Thống kê tổng hợp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <main class="container py-5">
        <h1 class="text-center mb-4">Thống kê tổng hợp</h1>

        <!-- Form lọc -->
        <div class="card p-4 mb-5">
            <form id="filterForm" method="get" th:action="@{/stats}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="time" class="form-label">Thời gian</label>
                        <select class="form-select" id="time" name="time" onchange="onTimeChange()">
                            <option value="MONTH" th:selected="${time == 'MONTH'}">Theo tháng</option>
                            <option value="QUARTER" th:selected="${time == 'QUARTER'}">Theo quý</option>
                            <option value="YEAR" th:selected="${time == 'YEAR'}">Theo năm</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="year" class="form-label">Năm</label>
                        <input type="number" class="form-control" id="year" name="year" th:value="${selectedYear}" min="2000" max="2099" onchange="document.getElementById('filterForm').submit()">
                    </div>
                    <div class="col-md-4" id="periodContainer" style="display:none;">
                        <label for="period" class="form-label">Kỳ</label>
                        <select class="form-select" id="period" name="period" onchange="document.getElementById('filterForm').submit()">
                            <option value="ALL" th:selected="${period == 'ALL'}">Tất cả</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <!-- Biểu đồ Doanh thu -->
        <div class="card p-4 mb-5">
            <h5 class="mb-3">Doanh thu</h5>
            <canvas id="revenueChart" style="max-height: 380px;"></canvas>
        </div>

        <!-- Biểu đồ Tỷ lệ lấp phòng -->
        <div class="card p-4 mb-5">
            <h5 class="mb-3">Tỷ lệ lấp phòng</h5>
            <canvas id="occupancyChart" style="max-height: 380px;"></canvas>
        </div>

        <!-- Biểu đồ Đánh giá trung bình -->
        <div class="card p-4">
            <h5 class="mb-3">Đánh giá trung bình</h5>
            <canvas id="ratingChart" style="max-height: 380px;"></canvas>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        let chartInstance = null;
        const revenueData = /*[[${revenueData}]]*/ [];
        const occupancyData = /*[[${occupancyData}]]*/ [];
        const ratingData = /*[[${ratingData}]]*/ [];
        const selectedTime = /*[[${time}]]*/ 'MONTH';
        const selectedYear = /*[[${selectedYear}]]*/ '2025';
        const selectedPeriod = /*[[${period}]]*/ 'ALL';

        function renderCharts() {
            const time = document.getElementById('time').value;

            // Tạo dữ liệu từ chartData
            const labelsRevenue = [];
            const dataRevenue = [];
            revenueData.forEach(item => {
                let label;
                switch(time) {
                    case 'MONTH':
                        label = `Tháng ${item.period}`;
                        break;
                    case 'QUARTER':
                        label = `Quý ${item.period}`;
                        break;
                    case 'YEAR':
                        label = `Năm ${item.period}`;
                        break;
                }
                labelsRevenue.push(label);
                dataRevenue.push(item.revenue);
            });

            const ctx = document.getElementById('revenueChart').getContext('2d');

            // Hủy biểu đồ cũ nếu tồn tại
            if (chartInstance) {
                chartInstance.destroy();
            }

            const titleText = (selectedPeriod && selectedPeriod !== 'ALL')
                ? ''
                : (time === 'MONTH' ? 'Tháng' : (time === 'QUARTER' ? 'Quý' : 'Năm'));

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsRevenue,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: dataRevenue,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Doanh thu (VNĐ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: titleText !== '',
                                text: titleText
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });
            // Occupancy chart (tháng cố định)
            const labelsOcc = Array.from({length: 12}, (_, i) => `Tháng ${i+1}`);
            const dataOcc = new Array(12).fill(0);
            occupancyData.forEach(item => {
                const idx = item.month - 1;
                if (idx >= 0 && idx < 12) dataOcc[idx] = Math.round((item.occupancyPercent || 0) * 100) / 100;
            });
            const ctxOcc = document.getElementById('occupancyChart').getContext('2d');
            new Chart(ctxOcc, {
                type: 'line',
                data: {
                    labels: labelsOcc,
                    datasets: [{
                        label: 'Tỷ lệ lấp phòng (%)',
                        data: dataOcc,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {beginAtZero: true, suggestedMax: 100}
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx){
                                    return 'Tỷ lệ: ' + ctx.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Rating chart (tháng cố định)
            const labelsRating = Array.from({length: 12}, (_, i) => `Tháng ${i+1}`);
            const dataRating = new Array(12).fill(0);
            const dataRatingCount = new Array(12).fill(0);
            ratingData.forEach(item => {
                const idx = item.month - 1;
                if (idx >= 0 && idx < 12) {
                    dataRating[idx] = item.avgRating;
                    dataRatingCount[idx] = item.count;
                }
            });
            const ctxRating = document.getElementById('ratingChart').getContext('2d');
            new Chart(ctxRating, {
                type: 'bar',
                data: {
                    labels: labelsRating,
                    datasets: [{
                        label: 'Điểm trung bình',
                        data: dataRating,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },{
                        label: 'Số đánh giá',
                        data: dataRatingCount,
                        type: 'line',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {beginAtZero: true, suggestedMax: 5},
                        y1: {position: 'right', beginAtZero: true}
                    }
                }
            });
        }

        function updatePeriodOptions(time){
            const container = document.getElementById('periodContainer');
            const sel = document.getElementById('period');
            if(!sel) return;
            sel.innerHTML = '';
            if(time === 'MONTH'){
                container.style.display = '';
                sel.appendChild(new Option('Tất cả', 'ALL', false, selectedPeriod==='ALL'));
                for(let m=1;m<=12;m++) sel.appendChild(new Option('Tháng '+m, String(m), false, selectedPeriod==String(m)));
            } else if(time === 'QUARTER'){
                container.style.display = '';
                sel.appendChild(new Option('Tất cả', 'ALL', false, selectedPeriod==='ALL'));
                for(let q=1;q<=4;q++) sel.appendChild(new Option('Quý '+q, String(q), false, selectedPeriod==String(q)));
            } else {
                container.style.display = 'none';
            }
            // Đảm bảo giá trị được chọn khớp model
            if (container.style.display !== 'none') {
                sel.value = selectedPeriod || 'ALL';
            }
        }

        function onTimeChange(){
            const time = document.getElementById('time').value;
            updatePeriodOptions(time);
            document.getElementById('filterForm').submit();
        }

        document.addEventListener('DOMContentLoaded', () => {
            updatePeriodOptions(selectedTime);
            renderCharts();
        });
    </script>
</body>
</html>
