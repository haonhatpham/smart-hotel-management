<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Thống kê tổng hợp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <th:block th:replace="base :: bt"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <nav th:replace="base :: menu"></nav>
    
    <main class="container py-5">
        <h1 class="text-center mb-4">Thống kê tổng hợp</h1>

        <!-- Form lọc -->
        <div class="card p-4 mb-5">
            <form id="filterForm" method="get" th:action="@{/stats}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="time" class="form-label">Thời gian</label>
                        <select class="form-select" id="time" name="time" onchange="document.getElementById('filterForm').submit()">
                            <option value="MONTH" th:selected="${time == 'MONTH'}">Theo tháng</option>
                            <option value="QUARTER" th:selected="${time == 'QUARTER'}">Theo quý</option>
                            <option value="YEAR" th:selected="${time == 'YEAR'}">Theo năm</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Năm</label>
                        <input type="number" class="form-control" id="year" name="year" th:value="${selectedYear}" min="2000" max="2099" onchange="document.getElementById('filterForm').submit()">
                    </div>
                </div>
            </form>
        </div>

        <!-- Biểu đồ Doanh thu -->
        <div class="card p-4 mb-5">
            <h5 class="mb-3">Doanh thu</h5>
            <canvas id="revenueChart" style="max-height: 380px;"></canvas>
        </div>

        <!-- Biểu đồ Tỷ lệ lấp phòng -->
        <div class="card p-4 mb-5">
            <h5 class="mb-3">Tỷ lệ lấp phòng</h5>
            <canvas id="occupancyChart" style="max-height: 380px;"></canvas>
        </div>

        <!-- Biểu đồ Đánh giá trung bình -->
        <div class="card p-4">
            <h5 class="mb-3">Đánh giá trung bình</h5>
            <canvas id="ratingChart" style="max-height: 380px;"></canvas>
        </div>
    </main>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <footer th:replace="base :: footer"></footer>
    <script th:inline="javascript">
        let chartInstance = null;
        const revenueData = /*[[${revenueData}]]*/ [];
        const occupancyData = /*[[${occupancyData}]]*/ [];
        const ratingData = /*[[${ratingData}]]*/ [];
        const selectedTime = /*[[${time}]]*/ 'MONTH';
        const selectedYear = /*[[${selectedYear}]]*/ '2025';

        function renderCharts() {
            const time = document.getElementById('time').value;

            // Revenue Chart
            const labelsRevenue = [];
            const dataRevenue = [];
            revenueData.forEach(item => {
                let label;
                switch(time) {
                    case 'MONTH':
                        label = `Tháng ${item.period}`;
                        break;
                    case 'QUARTER':
                        label = `Quý ${item.period}`;
                        break;
                    case 'YEAR':
                        label = `Năm ${item.period}`;
                        break;
                }
                labelsRevenue.push(label);
                dataRevenue.push(item.revenue);
            });

            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsRevenue,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: dataRevenue,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Doanh thu (VNĐ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });

            // Occupancy Chart
            const labelsOcc = [];
            const dataOcc = [];
            occupancyData.forEach(item => {
                let label;
                switch(time) {
                    case 'MONTH':
                        label = `Tháng ${item.period}`;
                        break;
                    case 'QUARTER':
                        label = `Quý ${item.period}`;
                        break;
                    case 'YEAR':
                        label = `Năm ${item.period}`;
                        break;
                }
                labelsOcc.push(label);
                dataOcc.push(Math.round((item.occupancyPercent || 0) * 100) / 100);
            });

            const ctxOcc = document.getElementById('occupancyChart').getContext('2d');
            new Chart(ctxOcc, {
                type: 'line',
                data: {
                    labels: labelsOcc,
                    datasets: [{
                        label: 'Tỷ lệ lấp phòng (%)',
                        data: dataOcc,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {beginAtZero: true, suggestedMax: 100}
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx){
                                    return 'Tỷ lệ: ' + ctx.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Rating Chart
            const labelsRating = [];
            const dataRating = [];
            const dataRatingCount = [];
            ratingData.forEach(item => {
                let label;
                switch(time) {
                    case 'MONTH':
                        label = `Tháng ${item.period}`;
                        break;
                    case 'QUARTER':
                        label = `Quý ${item.period}`;
                        break;
                    case 'YEAR':
                        label = `Năm ${item.period}`;
                        break;
                }
                labelsRating.push(label);
                dataRating.push(item.avgRating);
                dataRatingCount.push(item.count);
            });

            const ctxRating = document.getElementById('ratingChart').getContext('2d');
            new Chart(ctxRating, {
                type: 'bar',
                data: {
                    labels: labelsRating,
                    datasets: [{
                        label: 'Điểm trung bình',
                        data: dataRating,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },{
                        label: 'Số đánh giá',
                        data: dataRatingCount,
                        type: 'line',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {beginAtZero: true, suggestedMax: 5},
                        y1: {position: 'right', beginAtZero: true}
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderCharts();
        });
    </script>
</body>
</html>
